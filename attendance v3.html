<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LHS Online Attendance Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Define shades of green */
        .bg-primary-green { background-color: #16a34a; } /* Green 600 */
        .bg-secondary-green { background-color: #dcfce7; } /* Green 100 */
        .text-primary-green { color: #15803d; } /* Green 700 */
        .border-primary-green { border-color: #16a34a; }
        .hover\:bg-primary-green-dark:hover { background-color: #15803d; } /* Green 700 for hover */
        .ring-primary-green:focus { ring-color: #16a34a; }
        .focus\:border-primary-green:focus { border-color: #16a34a; }
        .focus\:ring-primary-green:focus { --tw-ring-color: #16a34a; }

        /* Hide elements */
        .hidden-section { display: none; }

        /* Style for generated QR code */
        #qrcode-display img {
            margin: 1rem auto;
            display: block;
            border: 5px solid #16a34a;
            border-radius: 8px;
            max-width: 100%; /* Ensure QR code scales down */
            height: auto;
        }
         #qr-reader-results {
             margin-top: 1rem;
             padding: 0.5rem;
             border: 1px solid #ccc;
             background-color: #f9f9f9;
             min-height: 40px;
             word-break: break-all;
             font-size: 0.875rem; /* Smaller text for results */
        }

        /* Table styling & responsiveness */
        .table-container { overflow-x: auto; /* Allow horizontal scroll on small screens */ }
        table { width: 100%; border-collapse: collapse; min-width: 600px; /* Prevent excessive squishing */}
        th, td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; white-space: nowrap; /* Prevent text wrapping */}
        th { background-color: #dcfce7; color: #15803d; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9fafb; }

        /* Ensure inputs are responsive */
        input[type="text"], input[type="email"], input[type="password"], input[type="time"], input[type="date"], input[type="week"], select {
             width: 100%; /* Make inputs take full width of their container */
        }

        /* Teacher Tabs Styling */
        .teacher-tab.active {
             border-color: #16a34a;
             color: #15803d;
             font-weight: 600; /* Make active tab bolder */
        }
        .teacher-tab:not(.active) {
             border-color: transparent;
             color: #6b7280; /* Gray 500 */
        }
         .teacher-tab:not(.active):hover {
             border-color: #d1d5db; /* Gray 300 */
             color: #374151; /* Gray 700 */
         }

        /* NEW: Toast Notification Styling */
        #notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            max-width: 90%;
            text-align: center;
            pointer-events: none; /* Allow clicking through */
        }
        #notification-toast.show {
            opacity: 1;
            bottom: 30px; /* Slide up effect */
            pointer-events: auto; /* Enable interaction when shown */
        }
        #notification-toast.success {
            background-color: #16a34a; /* primary-green */
            color: #ffffff;
        }
        #notification-toast.error {
            background-color: #ef4444; /* red-500 */
            color: #ffffff;
        }
        #notification-toast.info {
            background-color: #3b82f6; /* blue-500 */
            color: #ffffff;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-2 sm:p-4">

    <div id="notification-toast" role="alert"></div>

    <div class="bg-white p-4 sm:p-6 md:p-8 rounded-lg shadow-xl w-full max-w-7xl">
        <div class="text-center mb-6 sm:mb-8 border-b pb-4 border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
             <div class="flex items-center justify-center sm:justify-start">
                <img src="https://i.ibb.co/v4NRcFJy/Picsart-25-04-11-00-06-05-123.jpg" alt="LHS Logo" border="0" class="h-12 sm:h-16 w-auto mr-3 sm:mr-4 rounded-full">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-primary-green whitespace-nowrap">LHS Online Attendance</h1>
            </div>
            <button id="logout-button" onclick="logout()" class="hidden-section bg-red-500 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg shadow hover:bg-red-600 transition duration-300 text-xs sm:text-sm whitespace-nowrap">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
        </div>

        <div id="app-content">
            <div id="role-selection-view" class="text-center">
                <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-gray-700">Choose Your Role</h2>
                <div class="flex flex-col md:flex-row justify-center gap-4 sm:gap-6">
                    <button onclick="navigateTo('login', { role: 'student' })" class="bg-primary-green text-white px-6 py-3 sm:px-8 sm:py-4 rounded-lg shadow-md hover:bg-primary-green-dark transition duration-300 text-base sm:text-lg font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-user-graduate"></i> Student
                    </button>
                    <button onclick="navigateTo('login', { role: 'teacher' })" class="bg-primary-green text-white px-6 py-3 sm:px-8 sm:py-4 rounded-lg shadow-md hover:bg-primary-green-dark transition duration-300 text-base sm:text-lg font-medium flex items-center justify-center gap-2">
                        <i class="fas fa-chalkboard-teacher"></i> Teacher
                    </button>
                </div>
            </div>

            <div id="login-view" class="hidden-section max-w-md mx-auto">
                 <button onclick="navigateTo('role-selection')" class="mb-4 text-sm text-primary-green hover:underline">&larr; Back to Role Selection</button>
                 <div class="bg-secondary-green p-6 rounded-lg shadow-inner">
                    <h2 id="login-title" class="text-xl sm:text-2xl font-semibold mb-4 text-center text-primary-green">Login</h2>
                    <form id="login-form" onsubmit="handleLogin(event)">
                        <div id="login-fields" class="space-y-4">
                            </div>
                        <button type="submit" class="w-full mt-6 bg-primary-green text-white px-4 py-2 rounded-lg shadow hover:bg-primary-green-dark transition duration-300">Login</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-600">
                        Don't have an account?
                        <button id="go-to-signup" onclick="" class="font-medium text-primary-green hover:underline">Sign Up</button>
                    </p>
                 </div>
                 <div id="login-message-area" class="mt-4 text-center font-medium text-sm text-red-600 h-5"></div> </div>

            <div id="signup-view" class="hidden-section max-w-md mx-auto">
                 <button onclick="navigateTo('role-selection')" class="mb-4 text-sm text-primary-green hover:underline">&larr; Back to Role Selection</button>
                 <div class="bg-secondary-green p-6 rounded-lg shadow-inner">
                     <h2 id="signup-title" class="text-xl sm:text-2xl font-semibold mb-4 text-center text-primary-green">Create Account</h2>
                     <form id="signup-form" onsubmit="handleSignup(event)">
                         <div id="signup-fields" class="space-y-4">
                              </div>
                          <button type="submit" class="w-full mt-6 bg-primary-green text-white px-4 py-2 rounded-lg shadow hover:bg-primary-green-dark transition duration-300">Sign Up</button>
                     </form>
                     <p class="mt-4 text-center text-sm text-gray-600">
                         Already have an account?
                         <button id="go-to-login" onclick="" class="font-medium text-primary-green hover:underline">Login</button>
                     </p>
                 </div>
                 <div id="signup-message-area" class="mt-4 text-center font-medium text-sm text-red-600 h-5"></div> </div>

            <div id="student-dashboard-view" class="hidden-section mt-4 sm:mt-8">
                 <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary-green text-center">Student Dashboard</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                     <div class="bg-white p-4 sm:p-6 rounded-lg shadow order-first md:order-none">
                         <h3 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Scan Session QR Code</h3>
                         <p class="mb-4 text-xs sm:text-sm text-gray-600">Point your camera at the QR code provided by your teacher to record your attendance.</p>
                         <div id="qr-reader" class="w-full max-w-xs sm:max-w-sm mx-auto border-2 border-dashed border-primary-green rounded-lg p-1 sm:p-2 bg-gray-50 shadow-inner min-h-[200px] sm:min-h-[250px]"></div>
                         <div id="qr-reader-results" class="mt-3 sm:mt-4 p-2 border border-gray-300 bg-gray-50 rounded text-gray-700 min-h-[40px]">Scan status will appear here...</div>
                         <button onclick="startQrScanner()" class="mt-3 w-full bg-blue-500 text-white px-4 py-1.5 rounded-lg shadow hover:bg-blue-600 transition duration-300 text-sm">
                             <i class="fas fa-camera mr-1"></i> Start/Restart Scanner
                         </button>
                     </div>
                     <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                         <h3 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">My Attendance</h3>
                         <div class="mt-4 max-h-80 overflow-y-auto table-container">
                            <table>
                                <thead>
                                    <tr><th>Date</th><th>Subject</th><th>Time In</th><th>Status</th></tr>
                                </thead>
                                <tbody id="student-attendance-history">
                                    <tr><td colspan="4" class="text-center text-gray-500 py-4">No attendance records yet.</td></tr>
                                </tbody>
                            </table>
                         </div>
                     </div>
                 </div>
            </div>

            <div id="teacher-dashboard-view" class="hidden-section mt-4 sm:mt-8">
                 <h2 class="text-xl sm:text-2xl font-semibold mb-6 text-primary-green text-center">Teacher Dashboard</h2>
                 <div class="mb-6 border-b border-gray-200 overflow-x-auto">
                     <nav class="-mb-px flex space-x-4 sm:space-x-6" aria-label="Tabs">
                         <button onclick="showTeacherTab('manage-classes')" class="teacher-tab whitespace-nowrap py-3 px-2 sm:px-3 border-b-2 font-medium text-sm">Manage Classes</button>
                         <button onclick="showTeacherTab('create-session')" class="teacher-tab whitespace-nowrap py-3 px-2 sm:px-3 border-b-2 font-medium text-sm">Create Session</button>
                         <button onclick="showTeacherTab('view-attendance')" class="teacher-tab whitespace-nowrap py-3 px-2 sm:px-3 border-b-2 font-medium text-sm">View Attendance</button>
                         <button onclick="showTeacherTab('weekly-report')" class="teacher-tab whitespace-nowrap py-3 px-2 sm:px-3 border-b-2 font-medium text-sm">Weekly Report</button>
                     </nav>
                 </div>
                 <div id="teacher-content">
                     <div id="manage-classes-pane" class="teacher-pane">
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                             <div class="lg:col-span-1 bg-secondary-green p-4 rounded-lg shadow-inner">
                                 <h4 id="class-form-title" class="text-lg font-medium mb-3 text-primary-green">Create New Class Section</h4>
                                 <form id="class-section-form" onsubmit="handleSaveClass(event)">
                                     <input type="hidden" id="editing-section-original-name">
                                     <div class="mb-3">
                                         <label for="class-section-name" class="block text-sm font-medium text-gray-700 mb-1">Section Name</label>
                                         <input type="text" id="class-section-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                                     </div>
                                     <div class="mb-3">
                                         <label class="block text-sm font-medium text-gray-700 mb-1">Students</label>
                                         <div id="student-inputs" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                             </div>
                                         <button type="button" onclick="addStudentInput()" class="mt-2 text-sm text-primary-green hover:underline">+ Add Student</button>
                                     </div>
                                     <div class="flex gap-2 mt-4">
                                        <button type="submit" id="save-class-button" class="flex-1 bg-primary-green text-white px-4 py-2 rounded-lg shadow hover:bg-primary-green-dark transition duration-300 text-sm">Create Section</button>
                                        <button type="button" id="cancel-edit-button" onclick="resetClassForm()" class="hidden-section flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-500 transition duration-300 text-sm">Cancel Edit</button>
                                     </div>
                                 </form>
                                 <div id="class-form-message-area" class="mt-3 text-center font-medium text-sm text-red-600 h-5"></div>
                             </div>
                             <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-medium mb-3 text-gray-700">Existing Sections</h4>
                                <div id="class-sections-list" class="space-y-3 max-h-[30rem] overflow-y-auto">
                                    <p class="text-gray-500 text-sm">No sections created yet.</p>
                                </div>
                             </div>
                         </div>
                     </div>
                     <div id="create-session-pane" class="teacher-pane hidden-section">
                         <h3 class="text-xl font-semibold mb-4 text-gray-700">Create Attendance Session</h3>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                             <div class="bg-secondary-green p-4 rounded-lg shadow-inner">
                                 <form id="create-session-form" onsubmit="handleCreateSession(event)">
                                     <div class="mb-3">
                                         <label for="session-subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                         <input type="text" id="session-subject" required class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                                     </div>
                                     <div class="mb-3">
                                         <label for="session-class-section" class="block text-sm font-medium text-gray-700 mb-1">Class Section</label>
                                         <select id="session-class-section" required class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green bg-white">
                                             <option value="">-- Select Section --</option>
                                         </select>
                                     </div>
                                     <div class="grid grid-cols-2 gap-4 mb-3">
                                         <div>
                                             <label for="session-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                             <input type="time" id="session-start-time" required class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                                         </div>
                                         <div>
                                             <label for="session-end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                             <input type="time" id="session-end-time" required class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                                         </div>
                                     </div>
                                     <button type="submit" class="w-full mt-2 bg-primary-green text-white px-4 py-2 rounded-lg shadow hover:bg-primary-green-dark transition duration-300">Create Session & Generate QR</button>
                                 </form>
                                 <div id="session-form-message-area" class="mt-3 text-center font-medium text-sm text-red-600 h-5"></div>
                             </div>
                             <div class="bg-white p-4 rounded-lg shadow text-center">
                                 <h4 class="text-lg font-medium mb-3 text-gray-700">Session QR Code</h4>
                                 <div id="qrcode-display" class="min-h-[150px] sm:min-h-[200px] flex items-center justify-center">
                                     <p id="qrcode-placeholder" class="text-gray-500 text-sm">QR code will appear here after creating a session.</p>
                                 </div>
                                 <p id="qrcode-info" class="text-xs sm:text-sm text-gray-600 mt-2 break-words"></p>
                                 <button id="end-session-button" onclick="handleEndSession()" class="hidden-section mt-4 w-full bg-yellow-500 text-white px-4 py-1.5 rounded-lg shadow hover:bg-yellow-600 transition duration-300 text-sm">
                                     <i class="fas fa-stop-circle mr-1"></i> End This Session
                                 </button>
                             </div>
                         </div>
                     </div>
                     <div id="view-attendance-pane" class="teacher-pane hidden-section">
                         <h3 class="text-xl font-semibold mb-4 text-gray-700">View Attendance Records</h3>
                          <div class="mb-4 flex flex-col sm:flex-row gap-3 sm:gap-4 items-center">
                             <select id="view-attendance-section-filter" onchange="renderAttendanceView()" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green bg-white text-sm">
                                 <option value="">-- Filter by Section --</option>
                             </select>
                             <input type="date" id="view-attendance-date-filter" onchange="renderAttendanceView()" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green text-sm">
                             <button onclick="exportAttendance()" class="w-full sm:w-auto bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300 text-sm whitespace-nowrap">
                                 <i class="fas fa-file-csv mr-1"></i> Export CSV
                             </button>
                          </div>
                         <div id="attendance-record-display" class="bg-white p-4 rounded-lg shadow table-container">
                             <p class="text-gray-500 p-4">Select filters to view attendance records.</p>
                         </div>
                     </div>
                     <div id="weekly-report-pane" class="teacher-pane hidden-section">
                         <h3 class="text-xl font-semibold mb-4 text-gray-700">Weekly Attendance Report</h3>
                          <div class="mb-4 flex flex-col sm:flex-row gap-3 sm:gap-4 items-center">
                             <input type="week" id="weekly-report-week-filter" onchange="renderWeeklyReport()" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green text-sm">
                             <button onclick="exportWeeklyReport()" class="w-full sm:w-auto bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300 text-sm whitespace-nowrap">
                                 <i class="fas fa-file-csv mr-1"></i> Export CSV
                             </button>
                          </div>
                         <div id="weekly-report-display" class="bg-white p-4 rounded-lg shadow table-container">
                              <p class="text-gray-500 p-4">Select a week to view the report.</p>
                         </div>
                     </div>
                 </div>
            </div>
        </div>

        </div>

    <script>
        // --- DOM Elements ---
        const appContentDiv = document.getElementById('app-content');
        const logoutButton = document.getElementById('logout-button');
        const notificationToast = document.getElementById('notification-toast'); // NEW

        // Auth View Elements
        const loginView = document.getElementById('login-view'); // Added for direct access
        const signupView = document.getElementById('signup-view'); // Added for direct access
        const loginTitle = document.getElementById('login-title');
        const signupTitle = document.getElementById('signup-title');
        const loginFieldsDiv = document.getElementById('login-fields');
        const signupFieldsDiv = document.getElementById('signup-fields');
        const goToSignupButton = document.getElementById('go-to-signup');
        const goToLoginButton = document.getElementById('go-to-login');
        const loginMessageArea = document.getElementById('login-message-area'); // Specific message area
        const signupMessageArea = document.getElementById('signup-message-area'); // Specific message area

        // Student View Elements
        const qrReaderDiv = document.getElementById('qr-reader');
        const qrResultDiv = document.getElementById('qr-reader-results');
        const studentAttendanceHistoryTbody = document.getElementById('student-attendance-history');

        // Teacher View Elements
        const classFormTitle = document.getElementById('class-form-title');
        const classSectionForm = document.getElementById('class-section-form');
        const editingSectionOriginalNameInput = document.getElementById('editing-section-original-name');
        const classSectionNameInput = document.getElementById('class-section-name');
        const studentInputsDiv = document.getElementById('student-inputs');
        const saveClassButton = document.getElementById('save-class-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const classSectionsListDiv = document.getElementById('class-sections-list');
        const classFormMessageArea = document.getElementById('class-form-message-area'); // Specific message area

        const sessionClassSectionSelect = document.getElementById('session-class-section');
        const qrcodeDisplayDiv = document.getElementById('qrcode-display');
        const qrcodePlaceholder = document.getElementById('qrcode-placeholder');
        const qrcodeInfoP = document.getElementById('qrcode-info');
        const sessionFormMessageArea = document.getElementById('session-form-message-area'); // Specific message area
        const endSessionButton = document.getElementById('end-session-button'); // NEW

        const viewAttendanceSectionFilter = document.getElementById('view-attendance-section-filter');
        const viewAttendanceDateFilter = document.getElementById('view-attendance-date-filter');
        const attendanceRecordDisplayDiv = document.getElementById('attendance-record-display');

        const weeklyReportWeekFilter = document.getElementById('weekly-report-week-filter');
        const weeklyReportDisplayDiv = document.getElementById('weekly-report-display');

        // --- State Variables ---
        let currentView = 'role-selection'; // Tracks the current visible "page"
        let currentRole = null; // 'student' or 'teacher' (set during auth flow)
        let loggedInUserId = null; // Store ID of logged-in user
        let html5QrCode = null; // Scanner instance
        let qrcodeInstance = null; // Generator instance
        let editingSectionName = null; // Track which section is being edited
        let currentActiveSessionId = null; // Track the ID of the currently displayed QR code session
        let notificationTimeout = null; // NEW: For toast timer

        // --- Mock Data (Simulates Database - Lost on Refresh) ---
        // Using localStorage for slightly better persistence during demo
        let users = JSON.parse(localStorage.getItem('lhs_users')) || {
            "student123": { role: "student", password: "password", name: "Demo Student" },
            "teacher@example.com": { role: "teacher", password: "password", name: "Demo Teacher" }
        };
        let classSections = JSON.parse(localStorage.getItem('lhs_sections')) || {};
        let attendanceRecords = JSON.parse(localStorage.getItem('lhs_attendance')) || [];
        let activeSessions = JSON.parse(localStorage.getItem('lhs_sessions')) || {}; // Store active sessions

        // --- Data Persistence Functions ---
        function saveUsers() { localStorage.setItem('lhs_users', JSON.stringify(users)); }
        function saveSections() { localStorage.setItem('lhs_sections', JSON.stringify(classSections)); }
        function saveAttendance() { localStorage.setItem('lhs_attendance', JSON.stringify(attendanceRecords)); }
        function saveActiveSessions() { localStorage.setItem('lhs_sessions', JSON.stringify(activeSessions)); }

        // --- Utility Functions ---
        function showElement(element) { if(element) element.style.display = 'block'; }
        function showFlexElement(element) { if(element) element.style.display = 'flex'; }
        function hideElement(element) { if(element) element.style.display = 'none'; }
        function clearChildren(element) { if(element) element.innerHTML = ''; }

        // NEW: Toast Notification Function
        function showToastNotification(message, type = 'info', duration = 3000) {
            // Clear any existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }

            notificationToast.textContent = message;
            // Reset classes, then add base 'show' and specific type
            notificationToast.className = '';
            notificationToast.classList.add('show', type);

            // Automatically hide after duration
            notificationTimeout = setTimeout(() => {
                notificationToast.classList.remove('show');
                notificationTimeout = null;
            }, duration);
        }

        // Updated: Display message in specific areas (for form errors)
        function displayFormMessage(areaElement, msg, isError = true) {
            if (!areaElement) return;
            areaElement.textContent = msg;
            areaElement.style.color = isError ? '#dc2626' : '#16a34a'; // Red for error, Green for success (rarely used here)
            // Clear message after a few seconds
            setTimeout(() => { areaElement.textContent = ''; }, 5000);
        }

        function formatTime(timeString) { // HH:MM (24hr) to hh:mm AM/PM
             if (!timeString) return '';
             try {
                 const [hour, minute] = timeString.split(':').map(Number);
                 const ampm = hour >= 12 ? 'PM' : 'AM';
                 const formattedHour = hour % 12 || 12;
                 return `${formattedHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
             } catch (e) { return timeString; /* Return original if format is wrong */ }
        }
        function getCurrentDate() { return new Date().toISOString().split('T')[0]; }

        // --- Navigation ---
        function navigateTo(viewId, params = {}) {
            console.log(`Navigating to ${viewId} with params:`, params);
            currentView = viewId;
            // Hide all top-level views first
            const views = appContentDiv.children;
            for (let view of views) {
                hideElement(view);
            }
            // Show the target view
            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                showElement(targetView);
            } else {
                console.error(`View with ID ${viewId}-view not found!`);
                showElement(document.getElementById('role-selection-view')); // Fallback
                currentView = 'role-selection';
            }

            // Clear specific form messages on navigation
            if (loginMessageArea) loginMessageArea.textContent = '';
            if (signupMessageArea) signupMessageArea.textContent = '';
            if (classFormMessageArea) classFormMessageArea.textContent = '';
            if (sessionFormMessageArea) sessionFormMessageArea.textContent = '';

            // View-specific setup
            if (viewId === 'login' || viewId === 'signup') {
                currentRole = params.role || currentRole; // Keep role if navigating between login/signup
                if (!currentRole) { // If no role (e.g., direct navigation attempt), go back
                    navigateTo('role-selection');
                    return;
                }
                setupAuthForms(viewId, currentRole);
            } else if (viewId === 'student-dashboard') {
                if (!loggedInUserId) { navigateTo('role-selection'); return; } // Guard route
                startQrScanner(); // Attempt to start scanner when entering dashboard
                renderStudentAttendance();
            } else if (viewId === 'teacher-dashboard') {
                 if (!loggedInUserId) { navigateTo('role-selection'); return; } // Guard route
                stopQrScanner(); // Make sure student scanner is off
                populateSectionDropdowns();
                renderClassSectionsList();
                showTeacherTab('manage-classes'); // Default tab
                resetClassForm(); // Ensure class form is in create mode initially
            } else if (viewId === 'role-selection') {
                stopQrScanner();
                currentRole = null; // Clear role when going back to selection
                loggedInUserId = null; // Ensure logged out
                localStorage.removeItem('lhs_loggedin_user'); // Clear persisted login
            }

            // Show/hide logout button
            if (['student-dashboard', 'teacher-dashboard'].includes(viewId)) {
                 showElement(logoutButton);
            } else {
                 hideElement(logoutButton);
            }
            // displayMessage(''); // Clear old global messages (if any)
        }

        // --- Authentication Setup ---
        function setupAuthForms(viewId, role) {
            const isLogin = viewId === 'login';
            const formFieldsDiv = isLogin ? loginFieldsDiv : signupFieldsDiv;
            const titleElement = isLogin ? loginTitle : signupTitle;
            const switchButton = isLogin ? goToSignupButton : goToLoginButton;
            const otherViewId = isLogin ? 'signup' : 'login';

            titleElement.textContent = `${isLogin ? 'Login' : 'Create Account'} (${role.charAt(0).toUpperCase() + role.slice(1)})`;
            clearChildren(formFieldsDiv); // Clear previous fields

            // Define fields based on role
            let fieldsHtml = '';
            const passwordField = `
                <div>
                    <label for="${viewId}-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="${viewId}-password" name="${viewId}-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                </div>`;
            const nameField = `
                 <div>
                    <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signup-name" name="signup-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                </div>`;

            if (role === 'student') {
                const idField = `
                    <div>
                        <label for="${viewId}-id" class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                        <input type="text" id="${viewId}-id" name="${viewId}-id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                    </div>`;
                fieldsHtml = isLogin ? idField + passwordField : nameField + idField + passwordField;
            } else { // Teacher
                 const emailField = `
                    <div>
                        <label for="${viewId}-email" class="block text-sm font-medium text-gray-700 mb-1">Email / Gmail</label>
                        <input type="email" id="${viewId}-email" name="${viewId}-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                    </div>`;
                 fieldsHtml = isLogin ? emailField + passwordField : nameField + emailField + passwordField;
            }
            formFieldsDiv.innerHTML = fieldsHtml;

            // Set up the button to switch between login/signup
            switchButton.onclick = () => navigateTo(otherViewId, { role: role });
        }

        // --- Authentication Logic ---
        function handleLogin(event) {
            event.preventDefault();
            loginMessageArea.textContent = ''; // Clear previous errors
            const password = document.getElementById('login-password').value;
            let identifier;
            if (currentRole === 'student') identifier = document.getElementById('login-id').value;
            else identifier = document.getElementById('login-email').value;

            if (!identifier || !password) {
                displayFormMessage(loginMessageArea, 'Please fill in all fields.');
                return;
            }

            const user = users[identifier];

            if (user && user.role === currentRole && user.password === password) { // SIMULATED check
                console.log(`${currentRole} Login Success:`, identifier);
                loggedInUserId = identifier;
                localStorage.setItem('lhs_loggedin_user', JSON.stringify({ id: loggedInUserId, role: currentRole })); // Persist login
                showToastNotification('Login successful!', 'success', 2000); // Show toast
                // Navigate after a short delay
                setTimeout(() => {
                    navigateTo(currentRole === 'student' ? 'student-dashboard' : 'teacher-dashboard');
                }, 1000); // 1 second delay
            } else {
                displayFormMessage(loginMessageArea, 'Invalid credentials or role mismatch.');
            }
        }

        function handleSignup(event) {
            event.preventDefault();
            signupMessageArea.textContent = ''; // Clear previous errors
            const name = document.getElementById('signup-name').value;
            const password = document.getElementById('signup-password').value;
            let identifier;
            if (currentRole === 'student') identifier = document.getElementById('signup-id').value;
            else identifier = document.getElementById('signup-email').value;

            if (!name || !password || !identifier) {
                displayFormMessage(signupMessageArea, 'Please fill in all fields.');
                return;
            }

            if (users[identifier]) {
                displayFormMessage(signupMessageArea, `${currentRole === 'student' ? 'ID Number' : 'Email'} already exists.`);
            } else {
                users[identifier] = { role: currentRole, password: password, name: name }; // SIMULATED save
                saveUsers(); // Persist users
                console.log('Signup Success:', identifier, users[identifier]);

                // IMPROVED: Notify and auto-login
                showToastNotification('Account created! Logging you in...', 'success', 2500);
                loggedInUserId = identifier; // Set logged in user
                localStorage.setItem('lhs_loggedin_user', JSON.stringify({ id: loggedInUserId, role: currentRole })); // Persist login

                // Navigate after a delay to let user see the message
                setTimeout(() => {
                    navigateTo(currentRole === 'student' ? 'student-dashboard' : 'teacher-dashboard');
                }, 1500); // 1.5 second delay
            }
        }

        function logout() {
            console.log('Logging out...');
            loggedInUserId = null;
            currentRole = null;
            localStorage.removeItem('lhs_loggedin_user'); // Clear persisted login
            stopQrScanner();
            showToastNotification('Logged out successfully.', 'info');
            navigateTo('role-selection');
        }

        // --- Teacher: Manage Classes ---
        function createStudentInputDiv(name = '', id = '', isExisting = false) {
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center student-input-row';
            div.dataset.existing = isExisting; // Mark existing students during edit
            div.innerHTML = `
                <input type="text" placeholder="Student Name" value="${name}" class="student-name flex-1 px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                <input type="text" placeholder="ID Number" value="${id}" class="student-id flex-1 px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary-green focus:border-primary-green">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-lg font-bold leading-none px-1" title="Remove Student">&times;</button>
            `;
            return div;
        }
        function addStudentInput() {
            studentInputsDiv.appendChild(createStudentInputDiv());
        }
        function resetClassForm() {
            classFormTitle.textContent = 'Create New Class Section';
            classSectionForm.reset();
            editingSectionOriginalNameInput.value = '';
            clearChildren(studentInputsDiv);
            addStudentInput(); // Add one empty row
            saveClassButton.textContent = 'Create Section';
            hideElement(cancelEditButton);
            editingSectionName = null;
            classFormMessageArea.textContent = ''; // Clear messages
        }
        function handleSaveClass(event) {
            event.preventDefault();
            classFormMessageArea.textContent = ''; // Clear previous messages
            const newSectionName = classSectionNameInput.value.trim();
            const originalSectionName = editingSectionOriginalNameInput.value;
            const isEditing = !!originalSectionName;

            if (!newSectionName) { displayFormMessage(classFormMessageArea, "Section Name cannot be empty."); return; }

            // Check for name conflicts
            if (isEditing && newSectionName !== originalSectionName && classSections[newSectionName]) {
                 displayFormMessage(classFormMessageArea, `Another section named "${newSectionName}" already exists.`); return;
            }
             if (!isEditing && classSections[newSectionName]) {
                 displayFormMessage(classFormMessageArea, `Section "${newSectionName}" already exists.`); return;
             }

            const students = [];
            const studentRows = studentInputsDiv.querySelectorAll('.student-input-row');
            let hasValidStudent = false;
            studentRows.forEach(row => {
                const nameInput = row.querySelector('.student-name');
                const idInput = row.querySelector('.student-id');
                const name = nameInput.value.trim();
                const id = idInput.value.trim();
                if (name && id) {
                    students.push({ name: name, id: id });
                    hasValidStudent = true;
                } else if (name || id) {
                    console.warn("Incomplete student entry skipped:", name, id);
                }
            });

            if (!hasValidStudent) { displayFormMessage(classFormMessageArea, "Please add at least one student with both Name and ID."); return; }

            // --- SIMULATED SAVE ---
            if (isEditing && newSectionName !== originalSectionName) {
                delete classSections[originalSectionName];
            }
            classSections[newSectionName] = students;
            saveSections(); // Persist sections

            console.log(isEditing ? "Updated Class Section:" : "Created Class Section:", newSectionName, classSections[newSectionName]);
            showToastNotification(`Section "${newSectionName}" ${isEditing ? 'updated' : 'created'} successfully.`, 'success');
            resetClassForm();
            renderClassSectionsList();
            populateSectionDropdowns();
        }
        function editSection(sectionName) {
            const sectionData = classSections[sectionName];
            if (!sectionData) return;
            editingSectionName = sectionName;
            classFormTitle.textContent = `Edit Section: ${sectionName}`;
            classSectionNameInput.value = sectionName;
            editingSectionOriginalNameInput.value = sectionName;
            clearChildren(studentInputsDiv);
            if (sectionData.length > 0) {
                sectionData.forEach(student => {
                    studentInputsDiv.appendChild(createStudentInputDiv(student.name, student.id, true));
                });
            } else {
                 addStudentInput();
            }
            saveClassButton.textContent = 'Update Section';
            showElement(cancelEditButton);
            classSectionForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function renderClassSectionsList() {
            clearChildren(classSectionsListDiv);
            const sectionNames = Object.keys(classSections);
            if (sectionNames.length === 0) {
                classSectionsListDiv.innerHTML = '<p class="text-gray-500 text-sm">No sections created yet.</p>';
                return;
            }
            sectionNames.sort().forEach(name => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'p-3 border rounded-md bg-gray-50 hover:shadow-md transition-shadow duration-200';
                let studentListHtml = classSections[name].map(s => `<li class="text-xs ml-4">${s.name} (${s.id})</li>`).join('');
                if (!studentListHtml) studentListHtml = '<li class="text-xs text-gray-400 ml-4">No students added</li>';
                sectionDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1 gap-2">
                        <h5 class="font-medium text-primary-green break-all">${name}</h5>
                        <div class="flex gap-2 flex-shrink-0">
                             <button onclick="editSection('${name}')" class="text-blue-500 hover:text-blue-700 text-xs font-semibold" title="Edit Section">EDIT</button>
                             <button onclick="deleteSection('${name}')" class="text-red-500 hover:text-red-700 text-xs font-semibold" title="Delete Section">DELETE</button>
                        </div>
                    </div>
                    <ul class="list-disc list-inside text-gray-600">${studentListHtml}</ul>
                `;
                classSectionsListDiv.appendChild(sectionDiv);
            });
        }
         function deleteSection(sectionName) {
             if (confirm(`Are you sure you want to delete section "${sectionName}"? This cannot be undone.`)) {
                 delete classSections[sectionName];
                 saveSections(); // Persist
                 console.log("Deleted section:", sectionName);
                 showToastNotification(`Section "${sectionName}" deleted.`, 'info');
                 if (editingSectionName === sectionName) {
                     resetClassForm();
                 }
                 renderClassSectionsList();
                 populateSectionDropdowns();
                 renderAttendanceView(); // Update views that might depend on sections
                 renderWeeklyReport();
             }
         }
        function populateSectionDropdowns() {
            const sectionNames = Object.keys(classSections).sort();
            const optionsHtml = sectionNames.map(name => `<option value="${name}">${name}</option>`).join('');
            const placeholder = '<option value="">-- Select Section --</option>';
            sessionClassSectionSelect.innerHTML = placeholder + optionsHtml;
            viewAttendanceSectionFilter.innerHTML = placeholder + optionsHtml;
        }

        // --- Teacher: Create Session & QR Code ---
        function handleCreateSession(event) {
            event.preventDefault();
            sessionFormMessageArea.textContent = ''; // Clear message
            const subject = document.getElementById('session-subject').value.trim();
            const section = sessionClassSectionSelect.value;
            const startTime = document.getElementById('session-start-time').value;
            const endTime = document.getElementById('session-end-time').value;
            const date = getCurrentDate();

            if (!subject || !section || !startTime || !endTime) {
                displayFormMessage(sessionFormMessageArea, "Please fill all session details."); return;
            }
            if (new Date(`${date}T${endTime}`) <= new Date(`${date}T${startTime}`)) {
                displayFormMessage(sessionFormMessageArea, "End time must be after start time."); return;
            }

            // Simple unique ID generation
            const sessionId = `${subject.replace(/[^a-zA-Z0-9]/g, '')}-${section.replace(/[^a-zA-Z0-9]/g, '')}-${Date.now()}`;
            const qrData = JSON.stringify({ sessionId: sessionId, v: 1 }); // Keep payload small

            // Store session data
            activeSessions[sessionId] = { subject, section, startTime, endTime, date, qrData, isActive: true }; // Add isActive flag
            saveActiveSessions(); // Persist

            console.log("Created Session:", sessionId, activeSessions[sessionId]);

            // --- Generate QR Code ---
            clearChildren(qrcodeDisplayDiv);
            hideElement(qrcodePlaceholder);
            try {
                qrcodeInstance = new QRCode(qrcodeDisplayDiv, {
                    text: qrData, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M
                });
                 qrcodeInfoP.textContent = `QR Code for ${subject} - ${section} (${formatTime(startTime)} - ${formatTime(endTime)}) on ${date}`;
                 currentActiveSessionId = sessionId; // Store the ID of the session being displayed
                 showElement(endSessionButton); // Show the end session button
                 showToastNotification('Session created and QR code generated.', 'success');
            } catch (error) {
                 console.error("Error generating QR Code:", error);
                 displayFormMessage(sessionFormMessageArea, 'Error generating QR code.');
                 showElement(qrcodePlaceholder);
                 qrcodeInfoP.textContent = '';
                 hideElement(endSessionButton); // Hide button if QR fails
                 currentActiveSessionId = null;
            }
        }

        // NEW: Handle End Session
        function handleEndSession() {
            if (!currentActiveSessionId || !activeSessions[currentActiveSessionId]) {
                showToastNotification("No active session selected to end.", "error");
                return;
            }

            const sessionToEnd = activeSessions[currentActiveSessionId];
            sessionToEnd.isActive = false; // Mark as inactive instead of deleting
            saveActiveSessions(); // Persist change

            console.log("Ended Session:", currentActiveSessionId);
            showToastNotification(`Session for ${sessionToEnd.subject} - ${sessionToEnd.section} ended.`, 'info');

            // Clear QR display and hide button
            clearChildren(qrcodeDisplayDiv);
            showElement(qrcodePlaceholder);
            qrcodeInfoP.textContent = '';
            hideElement(endSessionButton);
            currentActiveSessionId = null;
        }


        // --- Data Fetching & Processing for Views ---
        function getAttendanceDataForView(sectionFilter, dateFilter) {
             const data = {
                 records: [],
                 session: null,
                 students: classSections[sectionFilter] || []
             };
             if (!sectionFilter || !dateFilter || data.students.length === 0) {
                 return data;
             }

             // Find the LATEST active or inactive session for this section/date for viewing purposes
             const potentialSessions = Object.entries(activeSessions)
                 .filter(([id, session]) => session.section === sectionFilter && session.date === dateFilter)
                 .sort(([, a], [, b]) => b.date.localeCompare(a.date)); // Sort descending by date (or creation time if available)

             const sessionEntry = potentialSessions[0]; // Get the most recent one for the day
             if (!sessionEntry) return data; // No session found for this day/section

             const [sessionId, sessionDetails] = sessionEntry;
             data.session = sessionDetails;
             data.session.id = sessionId; // Add id to session object for convenience

             // Filter raw attendance records for this specific session ID
             const relevantRecords = attendanceRecords.filter(rec => rec.sessionId === sessionId);

             const attendanceMap = new Map(); // studentId -> record
             relevantRecords.forEach(rec => {
                 attendanceMap.set(rec.studentId, {
                     ...rec,
                     timestampDate: new Date(rec.timestamp)
                 });
             });

             // Calculate status for each student in the section
             const sessionEndDateTime = new Date(`${dateFilter}T${data.session.endTime}`);
             const lateThresholdMinutes = 15;
             const lateDateTime = new Date(sessionEndDateTime.getTime() + lateThresholdMinutes * 60000);

             data.students.forEach(student => {
                 const record = attendanceMap.get(student.id);
                 let status = 'ABSENT';
                 let timestampStr = '---';
                 if (record) {
                     timestampStr = formatTime(record.timestamp.split('T')[1].substring(0, 5));
                     if (record.timestampDate <= sessionEndDateTime) {
                         status = 'ON TIME';
                     } else { // Considered LATE if after end time (as per PDF example logic)
                         status = 'LATE';
                     }
                 }
                 data.records.push({
                     name: student.name,
                     id: student.id,
                     timestamp: timestampStr,
                     status: status
                 });
             });

             // Sort records: ON TIME, LATE, ABSENT, then alphabetically by name
             data.records.sort((a, b) => {
                 const statusOrder = { 'ON TIME': 1, 'LATE': 2, 'ABSENT': 3 };
                 if (statusOrder[a.status] !== statusOrder[b.status]) {
                     return statusOrder[a.status] - statusOrder[b.status];
                 }
                 return a.name.localeCompare(b.name);
             });

             return data;
        }

        // --- Teacher: View Attendance Rendering ---
        function renderAttendanceView() {
            const selectedSection = viewAttendanceSectionFilter.value;
            const selectedDate = viewAttendanceDateFilter.value || getCurrentDate();
            viewAttendanceDateFilter.value = selectedDate; // Ensure date picker shows the used date

            if (!selectedSection) {
                attendanceRecordDisplayDiv.innerHTML = '<p class="text-gray-500 p-4">Please select a section to view attendance.</p>';
                return;
            }

            const { records, session, students } = getAttendanceDataForView(selectedSection, selectedDate);

            if (!session) {
                 attendanceRecordDisplayDiv.innerHTML = `<p class="text-gray-500 p-4">No session found for ${selectedSection} on ${selectedDate}.</p>`;
                 return;
            }
             if (students.length === 0) {
                 attendanceRecordDisplayDiv.innerHTML = `<p class="text-gray-500 p-4">Section "${selectedSection}" has no students added.</p>`;
                 return;
             }

             // Create table header
            let tableHtml = `
                <h4 class="text-lg font-medium mb-1 text-primary-green">${session.subject} - ${session.section}</h4>
                <p class="text-sm mb-3 text-gray-600">${selectedDate} (${formatTime(session.startTime)} - ${formatTime(session.endTime)}) ${session.isActive === false ? '<span class="text-red-600 font-semibold">(Ended)</span>' : ''}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Name</th>
                            <th>ID Number</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

             // Render table rows
             if (records.length === 0) { // Should only happen if section has no students
                 tableHtml += `<tr><td colspan="4" class="text-center text-gray-500 py-3">No students in this section.</td></tr>`;
             } else {
                 let currentStatus = '';
                 records.forEach(rec => {
                     // Add status header row when status changes
                     if (rec.status !== currentStatus) {
                         currentStatus = rec.status;
                         let statusClass = '';
                         if (currentStatus === 'ON TIME') statusClass = 'text-green-700 bg-green-100';
                         else if (currentStatus === 'LATE') statusClass = 'text-orange-700 bg-orange-100';
                         else statusClass = 'text-red-700 bg-red-100';
                         tableHtml += `<tr><td colspan="4" class="${statusClass} font-semibold py-1">${currentStatus}</td></tr>`;
                     }
                     // Student row
                     tableHtml += `
                        <tr>
                            <td></td> <td>${rec.name}</td>
                            <td>${rec.id}</td>
                            <td>${rec.timestamp}</td>
                        </tr>
                    `;
                 });
             }
            tableHtml += `</tbody></table>`;
            attendanceRecordDisplayDiv.innerHTML = tableHtml;
        }

        // --- Teacher: Weekly Report Rendering ---
        // Helper function to get week start/end dates from YYYY-Www format
        function getWeekDates(weekString) {
            try {
                const [year, week] = weekString.split('-W').map(Number);
                const janFirst = new Date(year, 0, 1);
                // Adjust to find the first Monday of the year or week 1 start
                const firstDayOfYear = janFirst.getDay() || 7; // Make Sunday 7
                const daysToFirstMonday = (8 - firstDayOfYear) % 7;
                let weekStart = new Date(year, 0, 1 + daysToFirstMonday + (week - 1) * 7);

                // Handle edge case where Jan 1st is late in the week (belongs to previous year's week 52/53)
                if (week === 1 && daysToFirstMonday > 3) {
                     weekStart = new Date(year, 0, 1 + daysToFirstMonday);
                }
                 // Adjust if week 1 starts in previous year
                 if (week > 50 && janFirst.getDay() !== 1 && janFirst.getDay() <=4 ) {
                     // This logic might need refinement based on strict ISO 8601 definition
                 }


                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                return {
                    start: weekStart.toISOString().split('T')[0],
                    end: weekEnd.toISOString().split('T')[0]
                };
            } catch (e) {
                console.error("Error parsing week string:", e);
                return null;
            }
        }

        function getWeeklyReportData(weekString) {
             const reportData = {
                 lates: [],
                 absences: [],
                 weekRange: null
             };
             if (!weekString) return reportData;

             const dateRange = getWeekDates(weekString);
             if (!dateRange) return reportData;
             reportData.weekRange = dateRange;

             // --- SIMULATED DATA AGGREGATION ---
             // Filter attendance records within the week range
             const weekStart = dateRange.start;
             const weekEnd = dateRange.end;

             const relevantAttendance = attendanceRecords.filter(rec => {
                 const recDate = rec.timestamp.split('T')[0];
                 return recDate >= weekStart && recDate <= weekEnd;
             });

             // Create a map of all expected attendances (students per session within the week)
             const expectedAttendance = new Map(); // sessionId -> Set<studentId>
             const sessionDetailsMap = new Map(); // sessionId -> { subject, section, date, startTime, endTime }

             Object.entries(activeSessions).forEach(([sessionId, session]) => {
                 if (session.date >= weekStart && session.date <= weekEnd && classSections[session.section]) {
                     const studentIds = new Set(classSections[session.section].map(s => s.id));
                     expectedAttendance.set(sessionId, studentIds);
                     sessionDetailsMap.set(sessionId, {
                         subject: session.subject, section: session.section, date: session.date,
                         startTime: session.startTime, endTime: session.endTime
                     });
                 }
             });

             // Map actual attendance
             const actualAttendance = new Map(); // sessionId -> Map<studentId, timestampDate>
             relevantAttendance.forEach(rec => {
                 if (!actualAttendance.has(rec.sessionId)) {
                     actualAttendance.set(rec.sessionId, new Map());
                 }
                 actualAttendance.get(rec.sessionId).set(rec.studentId, new Date(rec.timestamp));
             });

             // Determine Lates and Absences
             expectedAttendance.forEach((studentIdSet, sessionId) => {
                 const session = sessionDetailsMap.get(sessionId);
                 if (!session) return; // Should not happen

                 const sessionEndDateTime = new Date(`${session.date}T${session.endTime}`);
                 const studentRecords = actualAttendance.get(sessionId) || new Map();
                 const sectionStudents = classSections[session.section] || [];
                 const studentMap = new Map(sectionStudents.map(s => [s.id, s.name]));

                 studentIdSet.forEach(studentId => {
                     const studentName = studentMap.get(studentId) || `ID: ${studentId}`; // Fallback name
                     if (studentRecords.has(studentId)) {
                         // Attended - check if late
                         const arrivalTime = studentRecords.get(studentId);
                         if (arrivalTime > sessionEndDateTime) {
                             reportData.lates.push({
                                 name: studentName, section: session.section, subject: session.subject,
                                 date: session.date,
                                 arrival: formatTime(arrivalTime.toISOString().split('T')[1].substring(0, 5)),
                                 setTime: `${formatTime(session.startTime)}-${formatTime(session.endTime)}`
                             });
                         }
                     } else {
                         // Absent
                         reportData.absences.push({
                             name: studentName, section: session.section, subject: session.subject, date: session.date
                         });
                     }
                 });
             });


             // Sort data
             reportData.lates.sort((a,b) => a.date.localeCompare(b.date) || a.name.localeCompare(b.name));
             reportData.absences.sort((a,b) => a.date.localeCompare(b.date) || a.name.localeCompare(b.name));
             return reportData;
        }

        function renderWeeklyReport() {
            const selectedWeek = weeklyReportWeekFilter.value;
            if (!selectedWeek) {
                weeklyReportDisplayDiv.innerHTML = '<p class="text-gray-500 p-4">Select a week to view the report.</p>';
                return;
            }

            const { lates, absences, weekRange } = getWeeklyReportData(selectedWeek);

            if (!weekRange) {
                 weeklyReportDisplayDiv.innerHTML = '<p class="text-red-500 p-4">Invalid week selected.</p>';
                 return;
            }

            let tableHtml = `
                <h4 class="text-lg font-medium mb-2 text-primary-green">Weekly Report (${selectedWeek})</h4>
                <p class="text-sm mb-3 text-gray-600">Week Range: ${weekRange.start} to ${weekRange.end}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Section</th>
                            <th>Subject</th>
                            <th>Set Time</th>
                            <th>Arrival Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="text-orange-700 bg-orange-100 font-semibold py-1">LATE</td></tr>
            `;
            if (lates.length === 0) {
                 tableHtml += `<tr><td colspan="7" class="text-center text-gray-500 py-2">No late entries for this week.</td></tr>`;
            } else {
                lates.forEach(late => {
                    tableHtml += `
                        <tr>
                            <td>LATE</td>
                            <td>${late.date}</td>
                            <td>${late.name}</td>
                            <td>${late.section}</td>
                            <td>${late.subject}</td>
                            <td>${late.setTime || 'N/A'}</td>
                            <td>${late.arrival}</td>
                        </tr>`;
                });
            }
             tableHtml += `<tr><td colspan="7" class="text-red-700 bg-red-100 font-semibold py-1">ABSENT</td></tr>`;
             if (absences.length === 0) {
                 tableHtml += `<tr><td colspan="7" class="text-center text-gray-500 py-2">No absences for this week.</td></tr>`;
             } else {
                absences.forEach(absent => {
                    tableHtml += `
                        <tr>
                            <td>ABSENT</td>
                            <td>${absent.date}</td>
                            <td>${absent.name}</td>
                            <td>${absent.section}</td>
                            <td>${absent.subject}</td>
                            <td>---</td> <td>---</td> </tr>`;
                });
             }
            tableHtml += `</tbody></table>`;
            weeklyReportDisplayDiv.innerHTML = tableHtml;
            // NEW: Notify report generation
            showToastNotification("Weekly report generated.", "info");
        }

        // --- Teacher Tab Navigation ---
        function showTeacherTab(tabId) {
            document.querySelectorAll('.teacher-pane').forEach(pane => hideElement(pane));
            document.querySelectorAll('.teacher-tab').forEach(tab => tab.classList.remove('active'));
            showElement(document.getElementById(tabId + '-pane'));
            const activeTab = document.querySelector(`button[onclick="showTeacherTab('${tabId}')"]`);
            if(activeTab) activeTab.classList.add('active');

             // Trigger data rendering for relevant tabs if needed
             if (tabId === 'view-attendance') renderAttendanceView();
             else if (tabId === 'weekly-report') renderWeeklyReport();
             else if (tabId === 'manage-classes') renderClassSectionsList();
             else if (tabId === 'create-session') {
                 // Reset QR display when switching to this tab unless a session is active
                 if (!currentActiveSessionId) {
                     clearChildren(qrcodeDisplayDiv);
                     showElement(qrcodePlaceholder);
                     qrcodeInfoP.textContent = '';
                     hideElement(endSessionButton);
                 }
             }
        }

        // --- Student: QR Code Scanner ---
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Scan Success: ${decodedText}`);
            qrResultDiv.textContent = `Processing scan...`;
            qrResultDiv.style.color = '#15803d'; // Green

            try {
                const scannedData = JSON.parse(decodedText);
                if (scannedData && scannedData.sessionId && loggedInUserId) {
                    const session = activeSessions[scannedData.sessionId];

                    // Check if session exists and is ACTIVE
                    if (session && session.isActive) {
                        const existingRecord = attendanceRecords.find(rec => rec.sessionId === scannedData.sessionId && rec.studentId === loggedInUserId);

                        if (existingRecord) {
                             qrResultDiv.textContent = `Already recorded for ${session.subject} - ${session.section}.`;
                             qrResultDiv.style.color = '#ca8a04'; // Amber
                             showToastNotification('Attendance already recorded for this session.', 'info'); // Notify
                        } else {
                            const timestamp = new Date().toISOString();
                            attendanceRecords.push({
                                sessionId: scannedData.sessionId, studentId: loggedInUserId, timestamp: timestamp,
                                // Store relevant session details with record for easier history display
                                subject: session.subject, section: session.section,
                                sessionStartTime: session.startTime, sessionEndTime: session.endTime,
                                sessionDate: session.date
                            });
                            saveAttendance(); // Persist
                            console.log("Attendance Recorded:", attendanceRecords[attendanceRecords.length - 1]);
                             qrResultDiv.textContent = `Attendance recorded for ${session.subject}!`;
                             renderStudentAttendance(); // Update history table
                             showToastNotification(`Attendance recorded for ${session.subject}!`, 'success'); // Notify
                        }
                    } else if (session && !session.isActive) {
                        qrResultDiv.textContent = 'Error: This session has ended.';
                        qrResultDiv.style.color = '#dc2626'; // Red
                        showToastNotification('Attendance recording failed: Session has ended.', 'error'); // Notify
                    } else {
                        qrResultDiv.textContent = 'Error: Invalid session QR code.';
                        qrResultDiv.style.color = '#dc2626'; // Red
                        showToastNotification('Attendance recording failed: Invalid session.', 'error'); // Notify
                    }
                } else {
                    qrResultDiv.textContent = 'Error: Invalid QR data format.';
                    qrResultDiv.style.color = '#dc2626'; // Red
                    showToastNotification('Attendance recording failed: Invalid QR data.', 'error'); // Notify
                }
            } catch (error) {
                console.error("Error processing scanned data:", error);
                qrResultDiv.textContent = 'Error: Cannot read QR data.';
                qrResultDiv.style.color = '#dc2626'; // Red
                showToastNotification('Attendance recording failed: Could not read QR data.', 'error'); // Notify
            }
            // Consider stopping the scanner after processing, or let user restart
            // stopQrScanner(); // Uncomment if you want to stop after each scan
        }

        function onScanFailure(error) {
            // console.warn(`QR scan failure, error = ${error}`);
            // Don't display continuous errors, keep UI clean
        }

        function startQrScanner() {
            if (!loggedInUserId || currentRole !== 'student') return; // Only for logged-in students

            // Ensure the view is correct before starting
            if (currentView !== 'student-dashboard') {
                console.log("Not starting scanner, view is not student dashboard.");
                return;
            }

            if (html5QrCode && html5QrCode.isScanning) {
                 console.log("Scanner already running.");
                 qrResultDiv.textContent = 'Scanner is active.';
                 qrResultDiv.style.color = '#6b7280';
                 return;
            }

            // Initialize scanner if needed
            if (!html5QrCode) {
                 try {
                    html5QrCode = new Html5Qrcode("qr-reader", { formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] });
                 } catch (e) {
                     console.error("Failed to initialize Html5Qrcode:", e);
                     qrResultDiv.textContent = 'Error initializing scanner.';
                     qrResultDiv.style.color = '#dc2626';
                     return;
                 }
            }

            qrResultDiv.textContent = 'Initializing scanner...';
            qrResultDiv.style.color = '#6b7280'; // Gray

             Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const config = { fps: 5, qrbox: { width: 180, height: 180 }, aspectRatio: 1.0 };
                    // Prefer back camera ('environment')
                     const rearCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                     const cameraId = rearCamera ? rearCamera.id : devices[0].id; // Fallback to first camera

                    html5QrCode.start( cameraId, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        qrResultDiv.textContent = 'Scanner ready. Point at QR code.';
                        qrResultDiv.style.color = '#15803d'; // Green
                        console.log("QR Scanner Started with camera:", cameraId);
                    })
                    .catch(err => {
                        console.error("Scanner Start Error:", err);
                        qrResultDiv.textContent = 'Scanner Error. Check Permissions.';
                        qrResultDiv.style.color = '#dc2626'; // Red
                    });
                } else {
                    console.error("No cameras found.");
                    qrResultDiv.textContent = 'No camera found.';
                    qrResultDiv.style.color = '#dc2626'; // Red
                }
            }).catch(err => {
                console.error("Camera Access Error:", err);
                qrResultDiv.textContent = 'Camera access error. Allow camera permission.';
                qrResultDiv.style.color = '#dc2626'; // Red
            });
        }

         async function stopQrScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                try {
                    await html5QrCode.stop();
                    console.log("QR Code scanning stopped.");
                    // Keep the last status message in qrResultDiv
                } catch (err) {
                    console.error("Error stopping QR scanner:", err);
                }
            }
         }

         // --- Student: View Attendance History ---
         function renderStudentAttendance() {
             if (!loggedInUserId || currentRole !== 'student') return;
             clearChildren(studentAttendanceHistoryTbody);

             const studentRecords = attendanceRecords
                 .filter(rec => rec.studentId === loggedInUserId)
                 .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first

            if (studentRecords.length === 0) {
                 studentAttendanceHistoryTbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No attendance records yet.</td></tr>`; return;
            }

            studentRecords.forEach(rec => {
                 const arrivalTime = new Date(rec.timestamp);
                 // Use stored session end time for status calculation
                 const sessionEndDateTime = rec.sessionEndTime ? new Date(`${rec.sessionDate}T${rec.sessionEndTime}`) : null;
                 let status = 'RECORDED'; // Default if session time info missing
                 let statusClass = 'text-gray-500';

                 if (sessionEndDateTime) {
                     if (arrivalTime <= sessionEndDateTime) {
                         status = 'ON TIME';
                         statusClass = 'text-green-600';
                     } else {
                         status = 'LATE';
                         statusClass = 'text-orange-600';
                     }
                 }

                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                     <td>${rec.sessionDate || rec.timestamp.split('T')[0]}</td> <td>${rec.subject || 'N/A'}</td>
                     <td>${formatTime(rec.timestamp.split('T')[1].substring(0, 5))}</td>
                     <td class="${statusClass} font-medium">${status}</td>
                 `;
                 studentAttendanceHistoryTbody.appendChild(tr);
            });
         }

        // --- CSV Export ---
        function escapeCsvCell(cellData) {
            const stringData = String(cellData === null || cellData === undefined ? '' : cellData);
            if (stringData.includes(',') || stringData.includes('"') || stringData.includes('\n')) {
                const escapedData = stringData.replace(/"/g, '""');
                return `"${escapedData}"`;
            }
            return stringData;
        }
        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                showToastNotification("No data to export.", "error"); // Use toast
                return;
            }
            let csvContent = "";
             let headers = [];
             if (Array.isArray(rows[0])) {
                 headers = rows[0];
                 rows = rows.slice(1);
             } else if (typeof rows[0] === 'object' && rows[0] !== null) {
                 headers = Object.keys(rows[0]);
                 rows = rows.map(obj => headers.map(header => obj[header]));
             } else {
                  showToastNotification("Invalid data format for CSV export.", "error"); // Use toast
                  return;
             }

            csvContent += headers.map(escapeCsvCell).join(',') + '\r\n';
            rows.forEach(rowArray => {
                 csvContent += rowArray.map(escapeCsvCell).join(',') + '\r\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                 showToastNotification("CSV export started.", "success"); // Use toast
            } else {
                 showToastNotification("CSV export not supported by your browser.", "error"); // Use toast
            }
        }
        function exportAttendance() {
            const selectedSection = viewAttendanceSectionFilter.value;
            const selectedDate = viewAttendanceDateFilter.value || getCurrentDate();
            if (!selectedSection) { showToastNotification("Please select a section to export.", "error"); return; }

            const { records, session } = getAttendanceDataForView(selectedSection, selectedDate);
            if (!session || records.length === 0) { showToastNotification("No attendance data found for export.", "error"); return; }

            const filename = `attendance_${selectedSection}_${selectedDate}.csv`;
            const headers = ["Status", "Name", "ID Number", "Timestamp"];
            const dataRows = records.map(rec => [rec.status, rec.name, rec.id, rec.timestamp]);
            exportToCsv(filename, [headers, ...dataRows]);
        }
        function exportWeeklyReport() {
            const selectedWeek = weeklyReportWeekFilter.value;
            if (!selectedWeek) { showToastNotification("Please select a week to export.", "error"); return; }

            const { lates, absences } = getWeeklyReportData(selectedWeek);
            if (lates.length === 0 && absences.length === 0) { showToastNotification("No report data found for export.", "error"); return; }

            const filename = `weekly_report_${selectedWeek}.csv`;
            const headers = ["Status", "Date", "Name", "Section", "Subject", "Set Time", "Arrival Time"];
            const dataRows = [];
            lates.forEach(late => dataRows.push(["LATE", late.date, late.name, late.section, late.subject, late.setTime || 'N/A', late.arrival]));
            absences.forEach(absent => dataRows.push(["ABSENT", absent.date, absent.name, absent.section, absent.subject, '---', '---']));

            dataRows.sort((a, b) => {
                 if (a[1] !== b[1]) return a[1].localeCompare(b[1]); // Date
                 const statusOrder = { "LATE": 1, "ABSENT": 2 };
                 if (statusOrder[a[0]] !== statusOrder[b[0]]) return statusOrder[a[0]] - statusOrder[b[0]]; // Status
                 return a[2].localeCompare(b[2]); // Name
            });
            exportToCsv(filename, [headers, ...dataRows]);
            // Notification is handled by exportToCsv
        }

        // --- Check for existing login on load ---
        function checkPersistedLogin() {
            const loggedInData = localStorage.getItem('lhs_loggedin_user');
            if (loggedInData) {
                try {
                    const userData = JSON.parse(loggedInData);
                    if (userData && userData.id && userData.role && users[userData.id] && users[userData.id].role === userData.role) {
                        console.log("Found persisted login:", userData);
                        loggedInUserId = userData.id;
                        currentRole = userData.role;
                        navigateTo(currentRole === 'student' ? 'student-dashboard' : 'teacher-dashboard');
                    } else {
                        // Invalid data, clear it
                        localStorage.removeItem('lhs_loggedin_user');
                        navigateTo('role-selection');
                    }
                } catch (e) {
                    console.error("Error parsing persisted login data:", e);
                    localStorage.removeItem('lhs_loggedin_user');
                    navigateTo('role-selection');
                }
            } else {
                 navigateTo('role-selection'); // Start with role selection if no persisted login
            }
        }


        // --- Initial Setup ---
        window.onload = () => {
            checkPersistedLogin(); // Check for login first
            viewAttendanceDateFilter.value = getCurrentDate(); // Set default date
            addStudentInput(); // Add initial student row to class form
        };

        // Stop scanner when navigating away or closing tab
        window.addEventListener('beforeunload', stopQrScanner);

    </script>
</body>
</html>
